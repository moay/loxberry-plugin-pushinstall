#!/usr/bin/env bash

###########
# Checking if is run from a plugin root directory
###########

if [ ! -f ./plugin.cfg ]; then
    echo Please run this command from your plugin root folder. Go there and call "./vendor/bin/pushinstall"
    exit 1
fi


###########
# Some preparations
###########

echo Let\'s install your plugin on your local LoxBerry.

SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do # resolve $SOURCE until the file is no longer a symlink
  DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE" # if $SOURCE was a relative symlink, we need to resolve it relative to the path where the symlink file was located
done
SCRIPTDIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"

source $SCRIPTDIR/loxberry-connection-details

SPIN_QUESTION="Your LoxBerry SecurePin"
read -p "$SPIN_QUESTION: " username_spin


###########
# Packaging and upload of the plugin
###########

echo Zipping current plugin
zip -qr pushinstall_release.zip . -x "./vendor/*" "./.*"

echo Uploading release
scp pushinstall_release.zip $LOXBERRY_USERNAME@$LOXBERRY_IP:~
rm pushinstall_release.zip


###########
# Setup via ssha
###########

ssh -tt $LOXBERRY_USERNAME@$LOXBERRY_IP << EOF
   rm -rf pushinstall_release
   unzip -q pushinstall_release.zip -d pushinstall_release
   rm pushinstall_release.zip
   cd pushinstall_release
   sudo /opt/loxberry/sbin/plugininstall.pl action=install folder=. pin=$username_spin
   cd ..
   rm -rf pushinstall_release
   exit
EOF

echo
echo Done. \\o/
